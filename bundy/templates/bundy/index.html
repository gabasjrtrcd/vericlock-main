<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
    <meta id="theme-color" name="theme-color" content="#ffffff">
    <title>RCD Time and Attendance</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="./css/main.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
</head>

<body>
    <div class="mdl-card mdl-shadow--2dp" style="width: 500px; margin: auto;">
        <div class="mdl-card__title">
            <h2 class="mdl-card__title-text">Time and Attendance</h2>
        </div>

        <div class="mdl-layout__spacer"></div>

        <!-- <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="showVideo">Open camera</button> -->

        <form id="bundyForm" action="" method="post">
        {% csrf_token %}
            <select id="personList" name="person">
                <option disabled selected>Your name is:</option>
                {% for person in person_list %}
                <option value="{{ person.id }}">{{ person.name }}</option>
                {% endfor %}
            </select> 

            <main class="mdl-layout__content">
                <!-- <video id="gum-local" content="width=device-width, initial-scale=0.5" autoplay playsinline></video> -->
                <video id="gum-local" width="500" height="281" autoplay playsinline></video>
            </main>

            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--colored" id="timeIN" style="visibility: hidden;">IN</button>

            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" id="timeOUT" style="visibility: hidden;">OUT</button>

            <img id="photo" width="500" height="281" alt="Captured photo will appear here" style="display: none;">
        </form>
    </div>

    <div id="errorMsg"></div>

<script>
'use strict';

// Define video constraints
const videoConstraints = {
    audio: false,
    video: {width: 500, height: 280}
};

// Add event listener to the button for triggering media stream initialization
//document.querySelector('#showVideo').addEventListener('click', e => initialize(e));
//document.querySelector('#errorMsg').addEventListener('onload', e => initialize(e));
document.querySelector('#personList').addEventListener('click', initialize);
document.querySelector('#timeIN').addEventListener('click', e => {
    e.preventDefault();
    const snapshot = captureSnapshot();
    if (snapshot) {
        document.querySelector('#photo').src = URL.createObjectURL(snapshot);
        document.querySelector('#photo').style.display = 'block';
        // Optionally, you can submit the form or handle the snapshot as needed
        document.querySelector('#bundyForm').submit();
    }
});

// Initialization function to request and handle media stream
async function initialize(e) {
    try {
        const stream = await navigator.mediaDevices.getUserMedia(videoConstraints);
        attachVideoStream(stream);
        //e.target.disabled = true; // Disable the button after successful initialization
        //document.querySelector("#showVideo").disabled = true;
        //document.querySelector("#showVideo").style.visibility = "hidden";
        document.querySelector("#timeIN").style.visibility = "visible";
        document.querySelector("#timeOUT").style.visibility = "visible";
    } catch (error) {
        onCatch(error);
    }
}

// Function to handle successful acquisition of media stream
function attachVideoStream(stream) {
    const videoElement = document.querySelector('video');
    window.stream = stream; // Make variable available to the browser console
    videoElement.srcObject = stream;
}

// Function to handle errors during media stream acquisition
function onCatch(error) {
    const errorElement = document.querySelector('#errorMsg');
    errorElement.innerHTML += `<p>Something went wrong: ${error.name}</p>`;
}

// Capture a snapshot from the video stream
function captureSnapshot() {
    let imageCapture;

    navigator.mediaDevices.getUserMedia({ video: true }).then((mediaStream) => {
    document.querySelector("video").srcObject = mediaStream;

    const track = mediaStream.getVideoTracks()[0];
    imageCapture = new ImageCapture(track);

    return imageCapture.getPhotoCapabilities();
    });

    return imageCapture;
}
</script>
</body>
</html>